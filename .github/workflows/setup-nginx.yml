name: Setup Nginx

on:
  workflow_dispatch:
    inputs:
      domain:
        description: '도메인 (예: con-admin.tongpeoples.com)'
        required: true
        default: 'con-admin.tongpeoples.com'
      frontend_port:
        description: 'Frontend 포트'
        required: true
        default: '3001'
      backend_port:
        description: 'Backend 포트'
        required: true
        default: '3002'
      setup_ssl:
        description: 'SSL 인증서 발급 (yes/no)'
        required: true
        default: 'yes'

jobs:
  setup:
    runs-on: ubuntu-latest

    steps:
      - name: Setup Nginx via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          port: ${{ secrets.SERVER_PORT }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script_stop: false
          envs: DOMAIN,FRONTEND_PORT,BACKEND_PORT,SETUP_SSL,SERVER_PASSWORD
          script: |
            DOMAIN="${{ github.event.inputs.domain }}"
            FRONTEND_PORT="${{ github.event.inputs.frontend_port }}"
            BACKEND_PORT="${{ github.event.inputs.backend_port }}"
            SETUP_SSL="${{ github.event.inputs.setup_ssl }}"
            SERVER_PASSWORD="${{ secrets.SERVER_PASSWORD }}"

            echo "========== Nginx 설정 시작 =========="
            echo "도메인: $DOMAIN"
            echo "Frontend 포트: $FRONTEND_PORT"
            echo "Backend 포트: $BACKEND_PORT"

            # nginx 설정 파일 생성
            cat > /tmp/nginx_config.txt << 'NGINX_EOF'
            server {
                server_name DOMAIN_PLACEHOLDER;
                client_max_body_size 25m;

                # Backend API 프록시
                location /backend-api/ {
                    proxy_pass http://localhost:BACKEND_PORT_PLACEHOLDER/api/;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade $http_upgrade;
                    proxy_set_header Connection 'upgrade';
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                    proxy_cache_bypass $http_upgrade;
                }

                # Frontend 프록시
                location / {
                    proxy_pass http://localhost:FRONTEND_PORT_PLACEHOLDER;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade $http_upgrade;
                    proxy_set_header Connection 'upgrade';
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                    proxy_cache_bypass $http_upgrade;
                }

                listen 80;
            }
            NGINX_EOF

            # 플레이스홀더 치환
            sed -i "s/DOMAIN_PLACEHOLDER/$DOMAIN/g" /tmp/nginx_config.txt
            sed -i "s/FRONTEND_PORT_PLACEHOLDER/$FRONTEND_PORT/g" /tmp/nginx_config.txt
            sed -i "s/BACKEND_PORT_PLACEHOLDER/$BACKEND_PORT/g" /tmp/nginx_config.txt

            echo "생성된 nginx 설정:"
            cat /tmp/nginx_config.txt

            # 기존 설정 확인
            if [ -f "/etc/nginx/sites-available/$DOMAIN" ]; then
              echo "기존 설정 발견. 백업 후 업데이트합니다."
              echo -n "$SERVER_PASSWORD" > /tmp/pw.txt
              cat /tmp/pw.txt | sudo -S cp /etc/nginx/sites-available/$DOMAIN /etc/nginx/sites-available/${DOMAIN}.backup 2>&1
              rm -f /tmp/pw.txt
            fi

            # nginx 설정 복사
            echo "nginx 설정 파일 복사 중..."
            echo -n "$SERVER_PASSWORD" > /tmp/pw.txt
            cat /tmp/pw.txt | sudo -S cp /tmp/nginx_config.txt /etc/nginx/sites-available/$DOMAIN 2>&1
            rm -f /tmp/pw.txt

            # 심볼릭 링크 생성 (없는 경우)
            if [ ! -L "/etc/nginx/sites-enabled/$DOMAIN" ]; then
              echo "심볼릭 링크 생성 중..."
              echo -n "$SERVER_PASSWORD" > /tmp/pw.txt
              cat /tmp/pw.txt | sudo -S ln -sf /etc/nginx/sites-available/$DOMAIN /etc/nginx/sites-enabled/$DOMAIN 2>&1
              rm -f /tmp/pw.txt
            fi

            # nginx 설정 테스트
            echo "nginx 설정 테스트 중..."
            echo -n "$SERVER_PASSWORD" > /tmp/pw.txt
            cat /tmp/pw.txt | sudo -S nginx -t 2>&1
            NGINX_TEST=$?
            rm -f /tmp/pw.txt

            if [ $NGINX_TEST -ne 0 ]; then
              echo "nginx 설정 테스트 실패!"
              exit 1
            fi

            # nginx 재시작
            echo "nginx 재시작 중..."
            echo -n "$SERVER_PASSWORD" > /tmp/pw.txt
            cat /tmp/pw.txt | sudo -S systemctl reload nginx 2>&1
            rm -f /tmp/pw.txt

            echo "========== Nginx 설정 완료 =========="

            # SSL 인증서 발급
            if [ "$SETUP_SSL" = "yes" ]; then
              echo "========== SSL 인증서 발급 시작 =========="

              # DNS 확인
              echo "DNS 확인 중..."
              DNS_CHECK=$(dig +short $DOMAIN)
              if [ -z "$DNS_CHECK" ]; then
                echo "경고: DNS가 아직 설정되지 않았습니다. SSL 발급을 건너뜁니다."
                echo "도메인 DNS를 서버 IP로 설정한 후 수동으로 certbot을 실행하세요:"
                echo "sudo certbot --nginx -d $DOMAIN"
              else
                echo "DNS 확인됨: $DNS_CHECK"
                echo "certbot 실행 중..."
                echo -n "$SERVER_PASSWORD" > /tmp/pw.txt
                cat /tmp/pw.txt | sudo -S certbot --nginx -d $DOMAIN --non-interactive --agree-tos -m admin@example.com 2>&1 || echo "certbot 실행 실패 - 수동 확인 필요"
                rm -f /tmp/pw.txt
              fi

              echo "========== SSL 설정 완료 =========="
            fi

            # 최종 확인
            echo "========== 최종 상태 =========="
            echo -n "$SERVER_PASSWORD" > /tmp/pw.txt
            cat /tmp/pw.txt | sudo -S nginx -t 2>&1
            rm -f /tmp/pw.txt

            echo "Nginx 설정 완료!"
            rm -f /tmp/nginx_config.txt
