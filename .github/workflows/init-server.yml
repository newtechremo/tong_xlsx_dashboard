name: Initialize Server

on:
  workflow_dispatch:
    inputs:
      force_etl:
        description: 'ETL 강제 실행 (기존 DB 재생성)'
        required: false
        default: 'no'
        type: choice
        options:
          - 'no'
          - 'yes'

jobs:
  init:
    runs-on: ubuntu-latest

    steps:
      - name: Initialize Server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          port: ${{ secrets.SERVER_PORT }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script: |
            echo "========== 서버 초기 설정 시작 =========="

            # 프로젝트 디렉토리 생성
            mkdir -p /home/finefit-temp/Desktop/project
            cd /home/finefit-temp/Desktop/project

            # 기존 폴더 확인
            if [ -d "tong_xlsx_dashboard" ]; then
              echo "프로젝트 폴더가 이미 존재합니다. 업데이트합니다."
              cd tong_xlsx_dashboard
              git pull origin main
            else
              echo "프로젝트를 클론합니다."
              git clone https://github.com/newtechremo/tong_xlsx_dashboard.git
              cd tong_xlsx_dashboard
            fi

            # ===== 환경 설정 파일 생성 =====
            echo "환경 설정 파일 확인 중..."
            if [ ! -f ".env.local" ]; then
              echo "서버용 .env.local 파일 생성 중..."
              cat > .env.local << 'ENVEOF'
            # Server Environment
            # VITE_API_URL은 설정하지 않음 - 브라우저 접속 URL 기반으로 자동 결정됨
            # Nginx에서 /backend-api/ -> localhost:3002/api/ 프록시 설정됨
            ENVEOF
              echo ".env.local 파일 생성 완료"
            else
              echo ".env.local 파일이 이미 존재합니다."
            fi

            # ===== Frontend 의존성 설치 =====
            echo "Frontend 의존성 설치 중..."
            npm install

            # ===== Backend Conda 환경 설정 =====
            echo "Backend Conda 환경 설정 중..."
            source ~/anaconda3/etc/profile.d/conda.sh

            # conda 환경이 없으면 생성
            if ! conda env list | grep -q "tong-dashboard"; then
              echo "Conda 환경 생성 중..."
              conda create -n tong-dashboard python=3.10 -y
            fi

            conda activate tong-dashboard
            pip install -r backend/requirements.txt

            # ===== data_repository 확인 =====
            echo ""
            echo "========== 데이터 파일 확인 =========="
            if [ ! -d "data_repository" ]; then
              echo "WARNING: data_repository 폴더가 없습니다."
              echo ""
              echo "로컬에서 아래 명령어로 데이터를 업로드하세요:"
              echo "scp -P 6201 -r ./data_repository finefit-temp@49.168.236.221:/home/finefit-temp/Desktop/project/tong_xlsx_dashboard/"
              echo "비밀번호: remo1234!"
              echo ""
              echo "업로드 후 'Upload Data Files' 워크플로우를 실행하거나"
              echo "이 워크플로우를 다시 실행하세요."
            else
              echo "data_repository 폴더 확인됨"

              # 하위 폴더 확인
              echo "데이터 폴더 구조:"
              ls -la data_repository/ 2>/dev/null || echo "폴더 내용 없음"

              # ===== ETL 실행 =====
              FORCE_ETL="${{ inputs.force_etl }}"
              DB_EXISTS=false
              if [ -f "backend/database/safety.db" ]; then
                DB_EXISTS=true
              fi

              if [ "$DB_EXISTS" = false ] || [ "$FORCE_ETL" = "yes" ]; then
                echo ""
                echo "========== ETL 실행 =========="

                # 기존 DB 백업 (있는 경우)
                if [ "$DB_EXISTS" = true ]; then
                  cp backend/database/safety.db backend/database/safety.db.backup.$(date +%Y%m%d_%H%M%S)
                  echo "기존 DB 백업 완료"
                fi

                # ETL 실행
                cd /home/finefit-temp/Desktop/project/tong_xlsx_dashboard
                PYTHONPATH=. python -m backend.etl.run_etl

                if [ $? -eq 0 ]; then
                  echo "ETL 실행 완료"
                else
                  echo "ETL 실행 실패 - 데이터 파일 확인 필요"
                fi
              else
                echo "DB가 이미 존재합니다. ETL 건너뜀 (강제 실행: force_etl=yes)"
              fi
            fi

            echo ""
            echo "========== 서버 초기 설정 완료 =========="
            echo ""
            echo "다음 단계:"
            echo "1. data_repository가 없다면 업로드"
            echo "2. Deploy to Server 워크플로우 실행"
            echo "3. Setup Nginx 워크플로우 실행 (도메인 설정)"
